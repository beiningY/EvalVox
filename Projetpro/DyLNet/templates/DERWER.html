{% extends 'base.html' %}

{% block content %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<div class="container py-4">
    <a href="{% url 'conversion' %}" class="btn btn-outline-secondary me-md-2">retour</a>
    <h2 class="mb-4">Calcul du DER et du WER</h2>
    <div class="card">
        <div class="card-body">
            <form method="post" enctype="multipart/form-data">
                {% csrf_token %}
                <fieldset class="mb-3">
                    <legend>Sélectionnez le groupe cible:</legend>
                    <div class="form-check">
                        <input type="radio" id="adult" name="targetGroup" value="adult" class="form-check-input" required checked>
                        <label class="form-check-label" for="adult">Adult</label>
                    </div>
                    <div class="form-check">
                        <input type="radio" id="enfant" name="targetGroup" value="enfant" class="form-check-input" required>
                        <label class="form-check-label" for="enfant">Enfant</label>
                    </div>
                </fieldset>

                <div class="mb-3 wer-upload">
                    <label for="referenceFileWER" class="form-label">Téléchargez le fichier de référence WER (.json):</label>
                    <input type="file" id="referenceFileWER" name="referenceFileWER" class="form-control" required>
                </div>
                <div class="mb-3 wer-upload">
                    <label for="hypothesisFileWER" class="form-label">Télécharger le fichier d'hypothèse WER (.json):</label>
                    <input type="file" id="hypothesisFileWER" name="hypothesisFileWER" class="form-control" required>
                </div>

                <div class="mb-3 der-upload">
                    <label for="referenceFileDER" class="form-label">Télécharger le fichier de référence DER (.json):</label>
                    <input type="file" id="referenceFileDER" name="referenceFileDER" class="form-control" required>
                </div>
                <div class="mb-3 der-upload">
                    <label for="hypothesisFileDER" class="form-label">Télécharger le fichier d'hypothèse DER (.json):</label>
                    <input type="file" id="hypothesisFileDER" name="hypothesisFileDER" class="form-control" required>
                </div>
                <p class="text-muted">Notes: fichier reference converti par eaf2jsonWER et fichier hypothese converti par txt2json pour la partie WER</p>
                <p class="text-muted">Notes: fichier reference converti par eaf2jsonDER et fichier hypothese converti par textgrid2json pour la partie DER</p>
                <fieldset class="mb-4">
                    <legend>Sélectionnez le type d'analyse:</legend>
                    <div class="form-check">
                        <input type="radio" id="class" name="analysisType" value="class" class="form-check-input" required>
                        <label class="form-check-label" for="class">Classe</label>
                    </div>
                    <div class="form-check">
                        <input type="radio" id="situation" name="analysisType" value="situation" class="form-check-input" required>
                        <label class="form-check-label" for="situation">Situation</label>
                    </div>
                    <div class="form-check">
                        <input type="radio" id="speaker" name="analysisType" value="speaker" class="form-check-input" required>
                        <label class="form-check-label" for="speaker">Speaker</label>
                    </div>
                </fieldset>
                <button type="submit" class="btn btn-primary">Calculer</button>
            </form>
        </div>
    </div>
</div>
<div class="container mt-4">
    <div class="card">
        <div class="card-body" id="werResults">
            <h3>Résultats DER et WER</h3>
            {% if resultat %}
                <!-- WER Results -->
                {% if resultat|default:""|length > 0 and resultat.wer_results %}
                    <div class="results">
                        <h4>Résultats WER</h4>
                        {% for id, details in resultat.wer_results.items %}
                            <p><strong>ID {{ id }}:</strong> WER = {{ details.wer }}</p>
                        {% endfor %}
                    </div>
                {% endif %}
                <!-- DER Results -->
                <div class="results mt-3">
                    <h4>Résultats DER</h4>
                    {% if resultat.der_results %}
                        {% for id, details in resultat.der_results.items %}
                            <p><strong>ID {{ id }}:</strong> DER = {{ details.der }}{% if details.speaker_ids %}, Speaker IDs: {{ details.speaker_ids|join:", " }}{% endif %}</p>
                        {% endfor %}
                    {% elif resultat %}
                        {% for id, details in resultat.items %}
                            <p><strong>ID {{ id }}:</strong> DER = {{ details.der }}{% if details.speaker_ids %}, Speaker IDs: {{ details.speaker_ids|join:", " }}{% endif %}</p>
                        {% endfor %}
                    {% endif %}
                </div>
            {% endif %}
            <div class="chart-container">
                <h3>Diagramme à barres</h3>
                <canvas id="barChart"></canvas>
            </div>
            <div class="chart-container">
                <h3>Diagramme de dispersion</h3>
                <canvas id="scatterChart"></canvas>
            </div>
        </div>
    </div>
</div>
<script>
    document.addEventListener("DOMContentLoaded", function() {
        var targetGroupRadios = document.querySelectorAll('input[name="targetGroup"]');
        var werUploadSections = document.querySelectorAll('.wer-upload');
        var derUploadSections = document.querySelectorAll('.der-upload');
    
        function updateUploadSections() {
            var selectedValue = document.querySelector('input[name="targetGroup"]:checked').value;
    
            werUploadSections.forEach(function(section) {
                section.style.display = selectedValue === 'adult' ? '' : 'none';
                section.querySelectorAll('input').forEach(function(input) {
                    input.required = selectedValue === 'adult';
                });
            });
    
            derUploadSections.forEach(function(section) {
                section.style.display = '';
                section.querySelectorAll('input').forEach(function(input) {
                    input.required = true;
                });
            });
        }
    
        targetGroupRadios.forEach(function(radio) {
            radio.addEventListener('change', updateUploadSections);
        });
    
        updateUploadSections();
    
        // Define Bar Chart Data
        var barChartData = JSON.parse('{{ chart_data|safe }}');
        var barChartCtx = document.getElementById('barChart').getContext('2d');
        new Chart(barChartCtx, {
            type: 'bar',
            data: barChartData,
        });
    
        var scatterChartData = {
            datasets: [{
                label: 'Sample Scatter',
                data: JSON.parse('{{ scatter_data|safe }}'),
                backgroundColor: 'rgba(255, 99, 132, 0.5)',
                pointRadius: 15
            }]
        };
        var scatterChartCtx = document.getElementById('scatterChart').getContext('2d');
        new Chart(scatterChartCtx, {
            type: 'scatter',
            data: scatterChartData,
        });
    });
</script>
<style>
    .container {
        background-color: #f8f9fa; 
        padding: 20px;
        border-radius: 8px; 
    }
    
    .card {
        box-shadow: 0 4px 8px 0 rgba(0,0,0,0.2); 
        transition: 0.3s; 
    }
    
    .card:hover {
        box-shadow: 0 8px 16px 0 rgba(0,0,0,0.2); 
    }
    
    .card-body {
        padding: 20px; 
    }
    
    .btn-primary {
        width: 100%; 
        margin-top: 10px; 
    }
    
    .form-label {
        margin-bottom: 10px;
    }
    
    .form-control, .form-check-input, .form-check-label {
        margin-bottom: 20px; 
    }
    
    .form-check-label {
        display: block; 
    }
    </style>
{% endblock %}